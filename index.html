<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Living Garden — Pro UI (3x3)</title>
<style>
  :root {
    --bg: #0e0f12;
    --panel: #14161b;
    --panel-2: #1b1e25;
    --accent: #6ae38b;
    --accent-2: #77b7ff;
    --warn: #ffc85c;
    --danger: #ff6b6b;
    --text: #e8eef2;
    --muted: #a7b0ba;
    --line: #21252d;
    --shadow: 0 12px 30px rgba(0,0,0,0.35), 0 2px 6px rgba(0,0,0,0.4);
    --radius: 12px;
  }
  html, body { margin:0; height:100%; background:var(--bg); color:var(--text); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial; }
  .topbar {
    position:sticky; top:0; z-index:100;
    display:flex; align-items:center; gap:14px;
    padding:12px 16px; background:linear-gradient(180deg, rgba(20,22,27,0.95), rgba(20,22,27,0.6));
    border-bottom:1px solid var(--line); backdrop-filter: blur(8px);
  }
  .brand { font-weight:700; letter-spacing:0.3px; }
  .chip { padding:6px 10px; background:var(--panel-2); border:1px solid var(--line); border-radius:999px; font-size:13px; color:var(--muted); }
  .spacer { flex:1; }
  .controls { display:flex; align-items:center; gap:10px; }
  .btn {
    background:var(--panel-2); color:var(--text); border:1px solid var(--line);
    padding:8px 12px; border-radius:10px; cursor:pointer; user-select:none; transition:all .15s ease;
  }
  .btn:hover { filter:brightness(1.08); transform: translateY(-1px); }
  .btn:active { transform: translateY(0); }
  .btn.primary { background:linear-gradient(180deg, #2a343f, #202730); border-color:#2a3541; }
  .btn.ghost { background:transparent; }
  .slider { width:180px; accent-color: var(--accent); }
  .wrap { display:grid; grid-template-columns: 1fr 360px; gap:18px; padding:18px; }
  .board {
    background: radial-gradient(1200px 800px at 20% -20%, #1a2028, #121419);
    border:1px solid var(--line); border-radius:var(--radius); box-shadow: var(--shadow);
    padding:18px;
  }
  .grid {
    display:grid; grid-template-columns: repeat(3, 1fr); gap:12px;
  }
  .tile {
    position:relative; aspect-ratio:1/1; border-radius:10px; overflow:hidden; cursor:pointer;
    background: linear-gradient(180deg, #2b231e, #201a16); /* dirt base */
    border:1px solid #3a2f28; box-shadow: inset 0 4px 10px rgba(0,0,0,0.35), 0 3px 8px rgba(0,0,0,0.3);
    transition: transform .08s ease, filter .12s ease;
  }
  .tile:hover { transform: translateY(-2px); filter: brightness(1.06); }
  .tile .gloss { position:absolute; inset:0; background:linear-gradient(180deg, rgba(255,255,255,0.08), rgba(0,0,0,0)); pointer-events:none; }
  .tile .icon {
    position:absolute; inset:auto; left:50%; top:50%; transform: translate(-50%, -50%);
    font-size:34px; filter: drop-shadow(0 2px 3px rgba(0,0,0,0.45));
  }
  .badge {
    position:absolute; left:8px; top:8px; font-size:12px; color:var(--muted);
    background: rgba(0,0,0,0.35); border:1px solid var(--line);
    padding:3px 6px; border-radius:8px; backdrop-filter: blur(2px);
  }
  .bars { position:absolute; left:8px; right:8px; bottom:8px; display:grid; gap:6px; }
  .bar { height:6px; background:#13161b; border:1px solid var(--line); border-radius:999px; overflow:hidden; }
  .fill { height:100%; width:0%; background: linear-gradient(90deg, var(--accent), #7bf2b0); }
  .bar.blue .fill { background: linear-gradient(90deg, var(--accent-2), #9ed1ff); }
  .bar.gold .fill { background: linear-gradient(90deg, var(--warn), #ffe09b); }
  .bar.red .fill  { background: linear-gradient(90deg, var(--danger), #ff9e9e); }
  .tile.water  { background: linear-gradient(180deg, #1d3655, #14283f); border-color:#234566; }
  .tile.plant  { background: linear-gradient(180deg, #2a3a2f, #1b261e); border-color:#2e4936; }
  .tile.dead   { filter: grayscale(0.7) brightness(0.8); }
  .side {
    background: linear-gradient(180deg, var(--panel), #12151b); border:1px solid var(--line);
    border-radius:var(--radius); box-shadow: var(--shadow); padding:16px; display:flex; flex-direction:column; gap:12px;
  }
  .side h3 { margin:2px 0 6px; font-size:16px; letter-spacing:0.3px; }
  .pair { display:flex; align-items:center; justify-content:space-between; gap:8px; color:var(--muted); font-size:13px; }
  .stat { display:grid; gap:6px; }
  .stat .label { font-size:12px; color:var(--muted); }
  .input {
    width:100%; background:var(--panel-2); border:1px solid var(--line); border-radius:10px; color:var(--text);
    padding:8px 10px; outline:none;
  }
  .tools {
    position:sticky; bottom:0; z-index:50; margin:0 18px 18px; border-radius:14px;
    background:linear-gradient(180deg, rgba(20,22,27,0.9), rgba(20,22,27,0.7)); border:1px solid var(--line);
    box-shadow: var(--shadow); padding:10px; display:flex; gap:8px; flex-wrap: wrap; align-items:center;
    backdrop-filter: blur(8px);
  }
  .tool {
    display:flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; border:1px solid var(--line);
    background:var(--panel-2); color:var(--text); cursor:pointer; user-select:none; transition:all .15s;
  }
  .tool:hover { filter:brightness(1.08); transform: translateY(-1px); }
  .tool.active { outline: 2px solid var(--accent); background: linear-gradient(180deg, #26303a, #1d252d); }
  .kbd {
    font-size:11px; color:var(--muted); border:1px solid var(--line); padding:2px 6px; border-radius:6px; background:#0f1217;
  }
  .savebox { display:flex; gap:8px; }
  .notice { font-size:12px; color:var(--muted); }
  @media (max-width: 980px) { .wrap { grid-template-columns: 1fr; } }
</style>
</head>
<body>
  <div class="topbar">
    <div class="brand">Living Garden</div>
    <div class="chip" id="clock">Day 1, 06:00</div>
    <div class="chip" id="speedLabel">Speed: 1×</div>
    <div class="spacer"></div>
    <div class="controls">
      <button class="btn primary" id="btnPlay">Pause</button>
      <input class="slider" id="speed" type="range" min="0" max="8" step="1" value="1" title="Time speed">
      <button class="btn ghost" id="btnStep">Step 1h</button>
      <button class="btn" id="btnSave">Save</button>
      <button class="btn" id="btnLoad">Load</button>
    </div>
  </div>

  <div class="wrap">
    <div class="board">
      <div class="grid" id="grid"></div>
    </div>

    <aside class="side">
      <h3>Tile status</h3>
      <div class="pair"><div>Selected:</div><div id="selName">None</div></div>
      <div class="pair"><div>Kind:</div><div id="selKind">—</div></div>
      <div class="pair"><div>Stage:</div><div id="selStage">—</div></div>

      <div class="stat">
        <div class="label">Health</div>
        <div class="bar" id="bHealth"><div class="fill" style="width:0%"></div></div>
      </div>
      <div class="stat">
        <div class="label">Moisture</div>
        <div class="bar blue" id="bMoist"><div class="fill" style="width:0%"></div></div>
      </div>
      <div class="stat">
        <div class="label">Nutrients</div>
        <div class="bar gold" id="bNutr"><div class="fill" style="width:0%"></div></div>
      </div>
      <div class="stat">
        <div class="label">Pests</div>
        <div class="bar red" id="bPest"><div class="fill" style="width:0%"></div></div>
      </div>
      <div class="stat">
        <div class="label">pH (5–8 optimal ~6.5)</div>
        <div class="bar" id="bPH"><div class="fill" style="width:0%"></div></div>
      </div>

      <input id="nameEdit" class="input" placeholder="Rename plant…" />
      <div class="notice">Hotkeys: 1–6 tools • Space play/pause • ,/. slower/faster</div>

      <h3>Save / load</h3>
      <div class="savebox">
        <input id="saveCode" class="input" placeholder="Save code" />
        <button class="btn" id="btnCopy">Copy</button>
      </div>
      <div class="savebox">
        <input id="loadCode" class="input" placeholder="Paste save code" />
        <button class="btn" id="btnPaste">Load code</button>
      </div>
    </aside>
  </div>

  <div class="tools" id="tools"></div>

<script>
(function(){
  // ===== Model =====
  const SAVE_KEY = "lg_pro_3x3_v1";
  const SIZE = 3; // 3x3 patch
  const TICK_MS = 250; // base tick
  const HOUR_PER_TICK_AT_1X = 0.25; // 15 min per tick at 1×

  const Tools = [
    { id:"plant", name:"Plant", icon:"🌱", k:"1" },
    { id:"water", name:"Water", icon:"💧", k:"2" },
    { id:"fert",  name:"Fertilize", icon:"🧪", k:"3" },
    { id:"pest",  name:"Pesticide", icon:"🪲", k:"4" },
    { id:"prune", name:"Prune", icon:"✂️", k:"5" },
    { id:"remove",name:"Remove", icon:"🗑️", k:"6" },
  ];

  let state = blankState();
  let selected = 0; // index 0..8
  let tool = "plant";
  let playing = true;
  let speed = 1; // 0..8

  function blankTile() {
    return {
      kind: "dirt",
      name: "Empty soil",
      stage: "—",
      health: 0,       // 0..1 (plants only)
      moisture: 0.35,  // 0..1
      nutrients: 0.35, // 0..1
      pests: 0.00,     // 0..1 (higher is worse)
      ph: 6.5,         // ~5..8
      growth: 0.00,    // 0..1 (plants only)
      dead: false
    };
  }
  function blankState() {
    const tiles = Array.from({length:SIZE*SIZE}, blankTile);
    return { day:1, hour:6, tiles, rng: Math.random()*1e9|0 };
  }

  // ===== RNG (stable) =====
  function mulberry32(a) { return function() { var t = a += 0x6D2B79F5; t = Math.imul(t ^ t >>> 15, t | 1); t ^= t + Math.imul(t ^ t >>> 7, t | 61); return ((t ^ t >>> 14) >>> 0) / 4294967296; } }
  let rnd = mulberry32(state.rng);

  // ===== Encoding =====
  function encodeSave(obj) { const json = JSON.stringify(obj); return btoa(unescape(encodeURIComponent(json))); }
  function decodeSave(code) { const json = decodeURIComponent(escape(atob(code))); return JSON.parse(json); }

  // ===== Time =====
  let timer = setInterval(loop, TICK_MS);

  function loop() {
    if (playing && speed > 0) {
      const h = HOUR_PER_TICK_AT_1X * speed;
      advanceTime(h);
      tick(h);
      render();
    }
  }
  function advanceTime(h) {
    state.hour += h;
    while (state.hour >= 24) { state.hour -= 24; state.day++; }
  }

  // ===== Simulation (gentle, readable) =====
  function tick(hours) {
    const tiles = state.tiles;
    for (let i=0;i<tiles.length;i++) {
      const t = tiles[i];

      // environment drift
      t.moisture = clamp01(t.moisture - 0.01 * hours);
      t.nutrients = clamp01(t.nutrients - 0.004 * hours);
      t.pests = clamp01(t.pests + 0.006 * hours * (t.kind === "plant" ? 1.0 : 0.5));

      // plants live
      if (t.kind === "plant" && !t.dead) {
        // growth factors
        const moistOk = comfort(t.moisture, 0.55, 0.25);
        const nutrOk  = comfort(t.nutrients, 0.5, 0.35);
        const phOk    = comfortNorm(t.ph, 6.5, 1.2);
        const pestHit = 1 - clamp01(t.pests * 1.2);

        const growthRate = 0.02 * hours * moistOk * nutrOk * phOk * pestHit;
        t.growth = clamp01(t.growth + growthRate);

        // health trends
        const stress = (1 - moistOk)*0.5 + (1 - nutrOk)*0.3 + (1 - phOk)*0.2 + (t.pests)*0.6;
        const heal = (moistOk*0.3 + nutrOk*0.3 + phOk*0.2) * (1 - t.pests*0.5);
        t.health = clamp01(t.health + (heal - stress) * 0.02 * hours);

        // stage milestones
        t.stage = t.dead ? "Dead"
                 : t.growth < 0.33 ? "Seedling"
                 : t.growth < 0.66 ? "Young"
                 : t.growth < 0.99 ? "Mature"
                 : "Bloom";

        if (t.health <= 0.01 && t.growth > 0.1) t.dead = true;
      } else if (t.kind !== "plant") {
        t.health = 0; t.growth = 0; t.dead = false; t.stage = "—";
      }
    }
  }

  function clamp01(x){ return Math.max(0, Math.min(1, x)); }
  function comfort(x, center, halfspan) {
    const d = Math.abs(x - center);
    return clamp01(1 - d / halfspan); // 1 at center, 0 at edges
  }
  function comfortNorm(x, center, span) {
    const d = Math.abs(x - center) / span;
    return clamp01(1 - d); // 1 at center, 0 at center±span
  }

  // ===== Actions =====
  function applyTool(idx) {
    const t = state.tiles[idx];
    switch (tool) {
      case "plant":
        if (t.kind === "dirt" || t.kind === "dead") {
          Object.assign(t, blankTile(), {
            kind:"plant", name: randomPlantName(),
            health: 0.65, growth: 0.05, moisture: Math.max(t.moisture, 0.5),
            nutrients: Math.max(t.nutrients, 0.45), pests: 0.0, ph: 6.5, dead:false
          });
        }
        break;
      case "water":
        t.moisture = clamp01(t.moisture + 0.35);
        t.ph = clamp(t.ph - 0.1, 5.0, 8.5);
        if (t.kind === "plant") t.health = clamp01(t.health + 0.04);
        break;
      case "fert":
        t.nutrients = clamp01(t.nutrients + 0.4);
        t.ph = clamp(t.ph + 0.05, 5.0, 8.5);
        if (t.kind === "plant") t.health = clamp01(t.health + 0.03);
        break;
      case "pest":
        t.pests = clamp01(t.pests - 0.5);
        if (t.kind === "plant") t.health = clamp01(t.health + 0.02);
        break;
      case "prune":
        if (t.kind === "plant" && !t.dead) {
          t.growth = Math.max(0, t.growth - 0.05);
          t.health = clamp01(t.health + 0.06);
          t.pests = clamp01(t.pests - 0.1);
        }
        break;
      case "remove":
        Object.assign(t, blankTile());
        t.kind = "dirt"; t.name = "Empty soil";
        break;
    }
    render();
  }
  function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }

  function randomPlantName() {
    const A = ["Green", "Soft", "Little", "Sweet", "Bright", "Velvet", "Silver", "Golden"];
    const B = ["Sprout", "Fern", "Lily", "Mint", "Bloom", "Thyme", "Ivy", "Daisy"];
    return A[(rnd()*A.length)|0] + " " + B[(rnd()*B.length)|0];
  }

  // ===== UI =====
  const gridEl = document.getElementById('grid');
  const clockEl = document.getElementById('clock');
  const speedEl = document.getElementById('speed');
  const speedLabel = document.getElementById('speedLabel');
  const btnPlay = document.getElementById('btnPlay');
  const btnStep = document.getElementById('btnStep');

  const selName = document.getElementById('selName');
  const selKind = document.getElementById('selKind');
  const selStage = document.getElementById('selStage');
  const bHealth = document.querySelector('#bHealth .fill');
  const bMoist  = document.querySelector('#bMoist .fill');
  const bNutr   = document.querySelector('#bNutr .fill');
  const bPest   = document.querySelector('#bPest .fill');
  const bPH     = document.querySelector('#bPH .fill');
  const nameEdit = document.getElementById('nameEdit');

  const toolsEl = document.getElementById('tools');
  const btnSave = document.getElementById('btnSave');
  const btnLoad = document.getElementById('btnLoad');
  const saveCodeEl = document.getElementById('saveCode');
  const loadCodeEl = document.getElementById('loadCode');
  const btnCopy = document.getElementById('btnCopy');
  const btnPaste = document.getElementById('btnPaste');

  // Build grid
  function buildGrid() {
    gridEl.innerHTML = "";
    for (let i=0;i<SIZE*SIZE;i++) {
      const tile = document.createElement('div');
      tile.className = "tile";
      tile.dataset.idx = i;
      tile.innerHTML = `
        <div class="badge" data-badge></div>
        <div class="icon" data-icon>🪵</div>
        <div class="gloss"></div>
        <div class="bars">
          <div class="bar"><div class="fill" data-h style="width:0%"></div></div>
          <div class="bar blue"><div class="fill" data-m style="width:0%"></div></div>
          <div class="bar gold"><div class="fill" data-n style="width:0%"></div></div>
          <div class="bar red"><div class="fill" data-p style="width:0%"></div></div>
        </div>`;
      tile.addEventListener('click', onTileClick);
      gridEl.appendChild(tile);
    }
  }

  function onTileClick(e) {
    const idx = +e.currentTarget.dataset.idx;
    selected = idx;
    applyTool(idx);
    render();
  }

  // Build tools
  function buildTools() {
    toolsEl.innerHTML = "";
    Tools.forEach(t => {
      const b = document.createElement('div');
      b.className = "tool";
      b.dataset.id = t.id;
      b.innerHTML = `<span>${t.icon}</span><span>${t.name}</span><span class="kbd">${t.k}</span>`;
      b.addEventListener('click', () => { setTool(t.id); });
      toolsEl.appendChild(b);
    });
    setTool(tool);
  }

  function setTool(id) {
    tool = id;
    [...toolsEl.children].forEach(b => b.classList.toggle('active', b.dataset.id === id));
  }

  // Render
  function render() {
    updateClock();
    const tiles = state.tiles;
    for (let i=0;i<tiles.length;i++) {
      const t = tiles[i];
      const el = gridEl.children[i];
      const badge = el.querySelector('[data-badge]');
      const icon = el.querySelector('[data-icon]');
      const fh = el.querySelector('[data-h]');
      const fm = el.querySelector('[data-m]');
      const fn = el.querySelector('[data-n]');
      const fp = el.querySelector('[data-p]');

      el.classList.toggle('plant', t.kind === "plant");
      el.classList.toggle('water', t.kind === "water");
      el.classList.toggle('dead', t.dead);

      // badge: name or soil
      badge.textContent = t.kind === "plant" ? (t.name || "Plant") : "Soil";

      // icon
      let ico = "🪵";
      if (t.kind === "plant") {
        if (t.dead) ico = "☠️";
        else if (t.stage === "Seedling") ico = "🌱";
        else if (t.stage === "Young") ico = "🌿";
        else if (t.stage === "Mature") ico = "🌳";
        else if (t.stage === "Bloom") ico = "🌸";
      } else {
        ico = "🪵";
      }
      icon.textContent = ico;

      // bars
      fh.style.width = pct(t.health);
      fm.style.width = pct(t.moisture);
      fn.style.width = pct(t.nutrients);
      fp.style.width = pct(t.pests);

      // subtle cues for out-of-range pH by hue shift of health bar
      const phScore = comfortNorm(t.ph, 6.5, 1.2);
      const hHue = 120 * phScore; // 0=red, 120=green by pH fit
      fh.style.background = `linear-gradient(90deg, hsl(${hHue} 70% 60%), hsl(${Math.max(40,hHue)} 70% 70%))`;

      // selection outline via box-shadow
      el.style.outline = (i===selected) ? "2px solid var(--accent)" : "none";
    }

    // status panel
    const s = state.tiles[selected];
    selName.textContent = s ? s.name : "None";
    selKind.textContent = s ? (s.kind[0].toUpperCase()+s.kind.slice(1)) : "—";
    selStage.textContent = s ? s.stage : "—";
    bHealth.style.width = pct(s.health);
    bMoist.style.width  = pct(s.moisture);
    bNutr.style.width   = pct(s.nutrients);
    bPest.style.width   = pct(s.pests);
    const phFit = comfortNorm(s.ph, 6.5, 1.5);
    bPH.style.width = pct(phFit);

    nameEdit.value = s && s.kind === "plant" ? s.name : "";
    nameEdit.disabled = !(s && s.kind === "plant");
  }

  function pct(x){ return Math.round(clamp01(x)*100) + "%"; }

  function updateClock() {
    const hh = Math.floor(state.hour);
    const mm = Math.floor((state.hour - hh) * 60);
    const pad = n => String(n).padStart(2,'0');
    clockEl.textContent = `Day ${state.day}, ${pad(hh)}:${pad(mm)}`;
    speedLabel.textContent = `Speed: ${speed}×`;
    btnPlay.textContent = playing ? "Pause" : "Play";
  }

  // ===== Events =====
  btnPlay.addEventListener('click', () => { playing = !playing; render(); });
  speedEl.addEventListener('input', () => { speed = +speedEl.value; render(); });
  btnStep.addEventListener('click', () => { advanceTime(1); tick(1); render(); });

  nameEdit.addEventListener('input', () => {
    const s = state.tiles[selected];
    if (s && s.kind === "plant") s.name = nameEdit.value;
  });

  window.addEventListener('keydown', e => {
    const k = e.key.toLowerCase();
    if (k === ' ') { e.preventDefault(); playing = !playing; render(); return; }
    if (k === ',' ) { speed = Math.max(0, speed-1); speedEl.value = speed; render(); return; }
    if (k === '.' ) { speed = Math.min(8, speed+1); speedEl.value = speed; render(); return; }
    const map = { '1':'plant','2':'water','3':'fert','4':'pest','5':'prune','6':'remove' };
    if (map[k]) setTool(map[k]);
  });

  // ===== Save / Load =====
  function saveToLocal() {
    try {
      localStorage.setItem(SAVE_KEY, JSON.stringify(state));
      saveCodeEl.value = encodeSave(state);
      flash("Saved");
    } catch { flash("Save failed"); }
  }
  function loadFromLocal() {
    try {
      const s = localStorage.getItem(SAVE_KEY);
      if (!s) return flash("No save");
      adoptState(JSON.parse(s));
      flash("Loaded");
    } catch { flash("Load failed"); }
  }
  function adoptState(obj) {
    state = obj;
    rnd = mulberry32(state.rng || (Math.random()*1e9|0));
    render();
  }
  function loadFromCode(code) {
    try { adoptState(decodeSave(code)); flash("Loaded from code"); }
    catch { flash("Invalid code"); }
  }

  btnSave.addEventListener('click', saveToLocal);
  btnLoad.addEventListener('click', loadFromLocal);
  btnCopy.addEventListener('click', () => {
    const code = encodeSave(state); saveCodeEl.value = code;
    navigator.clipboard?.writeText(code); flash("Copied");
  });
  btnPaste.addEventListener('click', () => {
    const code = loadCodeEl.value.trim();
    if (code) loadFromCode(code);
  });

  // ===== UX helpers =====
  let flashTimer = null;
  function flash(msg) {
    const n = document.createElement('div');
    n.textContent = msg;
    Object.assign(n.style, {
      position:'fixed', left:'50%', top:'16px', transform:'translateX(-50%)',
      background:'rgba(0,0,0,0.7)', border:'1px solid var(--line)', color:'var(--text)',
      padding:'8px 12px', borderRadius:'10px', zIndex:9999, boxShadow:'var(--shadow)'
    });
    document.body.appendChild(n);
    clearTimeout(flashTimer); flashTimer = setTimeout(()=>n.remove(), 900);
  }

  // ===== Boot =====
  buildGrid();
  buildTools();
  render();

})();
</script>
</body>
</html>
